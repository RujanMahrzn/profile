<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScreenShare Pro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (keep all your existing CSS styles) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing HTML) ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... (keep all your existing variable declarations) ...

            async function startCamera() {
                try {
                    // Stop any existing stream
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                    }
                    
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: currentFacingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: true
                    });
                    
                    localVideo.srcObject = localStream;
                    localVideo.style.display = 'block';
                    if (localVideoPlaceholder) localVideoPlaceholder.style.display = 'none';
                    
                    isVideoOn = true;
                    isAudioOn = true;
                    updateUI();
                    
                    // Safely update the footer text
                    const localVideoFooter = document.querySelector('#localVideo + .card-footer small');
                    if (localVideoFooter) {
                        localVideoFooter.textContent = 'Camera active';
                    }
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    alert('Could not access camera: ' + error.message);
                    // Fall back to audio only
                    await startAudioOnly();
                }
            }

            async function startAudioOnly() {
                try {
                    // Stop any existing stream
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                    }
                    
                    localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    // Show audio-only UI
                    if (localVideo) localVideo.style.display = 'none';
                    if (localVideoPlaceholder) {
                        localVideoPlaceholder.style.display = 'flex';
                        localVideoPlaceholder.innerHTML = '<i class="fas fa-microphone"></i><p>Audio only mode</p>';
                    }
                    
                    isAudioOn = true;
                    isVideoOn = false;
                    updateUI();
                    
                    // Safely update the footer text
                    const localVideoFooter = document.querySelector('#localVideo + .card-footer small');
                    if (localVideoFooter) {
                        localVideoFooter.textContent = 'Audio only';
                    }
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('Could not access microphone: ' + error.message);
                }
            }

            // ... (keep all your remaining functions, but ensure they have proper null checks) ...

            function simulateRemoteConnection() {
                if (!isSessionActive) return;
                
                // Create a different looking stream for the remote user
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 360;
                const ctx = canvas.getContext('2d');
                
                // Create a gradient background
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#3498db');
                gradient.addColorStop(1, '#2ecc71');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add text
                ctx.fillStyle = 'white';
                ctx.font = '30px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Remote Participant', canvas.width/2, canvas.height/2);
                
                // Convert canvas to stream
                const stream = canvas.captureStream(15);
                
                // Display the remote stream
                if (remoteVideo) {
                    remoteVideo.srcObject = stream;
                    remoteVideo.style.display = 'block';
                }
                if (remoteVideoPlaceholder) remoteVideoPlaceholder.style.display = 'none';
                
                // Add a participant to the list
                const participantsList = document.getElementById('participantsList');
                if (participantsList) {
                    const newParticipant = document.createElement('li');
                    newParticipant.className = 'mb-2';
                    newParticipant.textContent = 'Remote User';
                    participantsList.appendChild(newParticipant);
                }
                
                // Update room status
                if (roomStatus) {
                    roomStatus.textContent = '2 participants';
                    roomStatus.className = 'badge bg-success';
                }
                
                // Update the remote video footer
                const remoteVideoFooter = document.querySelector('#remoteVideo + .card-footer small');
                if (remoteVideoFooter) {
                    remoteVideoFooter.textContent = 'Connected';
                }
                
                // Enable remote fullscreen button
                if (remoteFullscreenBtn) remoteFullscreenBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
